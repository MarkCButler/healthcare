---
title: 'Analysis of a Healthcare-Fraud Dataset'
output:
  html_document:
    code_folding: hide
    css: style.css
    highlight: tango
    number_sections: true
    theme: yeti
    toc: true
    toc_depth: 2
editor_options:
  chunk_output_type: console
---

```{js, echo=FALSE}
// Add a picture to the top of the page.  JavaScript is used because the
// formatting options for R markdown don't appear to allow an option to put
// the image above the document title.
let photo_html = '<img id="photo" src="images/fraud-photo.jpg" alt="photo">';
header = document.getElementById('header');
header.innerHTML = photo_html + header.innerHTML;
```

```{r, setup, message=FALSE, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    fig.align = 'center',
    comment = ''
)

library(dplyr)
library(ggplot2)
library(lubridate)
library(scales)
library(stlplus)
library(stringr)
library(tidyr)

# nolint start
# (using nolint to avoid a linter complaint about commented code)

# With default settings, plots appear crowded, so insert additional space
# below each plot.  This can be done by editing plot.margin in the theme
# system.  The default margin can be found using the command:
#
# theme_get()$plot.margin
#
# This gives 5.5 for each side.  Increase the top and bottom margins.
theme_update(plot.margin = margin(12, 5.5, 12, 5.5, 'pt'))

# nolint end
```

```{r, scripts, message=FALSE, echo=FALSE, cache=TRUE}
source('vectors.R')
source('data_frames.R')
source('plot.R')

# Reorder the vector of chronic conditions.  Loops over this vector are used
# to generate plots, so reordering the vector affects the order in which plots
# are produced.
chronic_conditions <- reorder_chronic_conditions(inpatients)
```

# Summary

Exploratory data analysis of a healthcare-fraud
[dataset](https://www.kaggle.com/rohitrox/healthcare-provider-fraud-detection-analysis)
from Kaggle is presented.  The analysis has two goals:

  - Provide general insight into the healthcare market represented by the
    dataset (apparently healthcare covered by Medicare)
  - Reveal associations involving the "potential fraud" label for healthcare
    providers in the training dataset

# Dataset {.tabset}

## Description {.unnumbered}

The dataset contains training data and test data, each with four data frames.

The training data was used for the analysis.  Details of the data frames:

  - Inpatient visits to a hospital (30 columns, <nobr>~ 40,000</nobr> rows, )
  - Outpatient visits to a hospital (27 columns, <nobr>~ 520,000</nobr> rows)
  - Patients who made these hospital visits (25 columns, <nobr>~ 140,000</nobr>
    rows)
  - Providers visited (2 columns:  provider ID and PotentialFraud label, 5,410
    rows)

The patients in dataset appear to Medicare patients residing in the US and
Africa.

## Scope {.unnumbered}

The hospital visits in the dataset occurred throughout 2009 and were mainly
limited to 2009.

The healthcare market represented by the dataset appears to be Medicare
patients, which include people who are 65 or older, certain younger people
with disabilities, and people with end-stage renal disease or ALS (Lou
Gehrig's disease).

  - The first clue leading to this conclusion is that for nearly all of the
    inpatient visits, the deductible paid by the patient was $1068, the 2009
    deductible for an inpatient visit covered by Medicare.  (About 2% of the
    inpatient visits had NA for the deductible paid, but for all other
    inpatient visits the deductible paid was $1068.)
  - Consistent with the special treatment of end-stage renal disease by
    Medicare, the csv table of patient info include a column of 0 and 1 values
    with column heading "Renal Disease."  This column is among other columns
    that identify a patient, such as birth date, gender and race.
  - The column names NoOfMonths_PartACov, NoOfMonths_PartBCov in the table of
    patients can also be understood in this context:  these columns likely
    gives the number of months in 2009 the patient had coverage by Medicare
    Part A and Medicare Part B, respectively.  (Each of these columns contains
    integer values from 0 to 12.)

The hospital patients appear to be residents of the US and Africa.

  - Each patient is identified with a state and a county, both labeled by
    integers (referred to here as codes).  There are 52 different state codes
    ranging from 1 to 54.  The county codes are three-digit integers ranging
    from 0 to 999.
  - The state and county codes appear to be components of 5-digit SSA
    (social-security administration) codes that identifies patient location.
    For example, the dataset includes 156 patients with state code 49 and
    county code 430, and these reside in Henrico County, Virginia (SSA code
    49430).
  - Several consistency support this conclusion.  For example, nearly all of
    the <nobr>~ 3,000</nobr> combinations of state code and county code in the
    dataset correspond to locations specified by a 5-digit SSA code.  Five US
    states (AK, CA, IL, NH, VA) in the dataset included county codes that I
    could not identify from the
    [data](https://www.nber.org/research/data/ssa-federal-information-processing-series-fips-state-and-county-crosswalk)
    published by the [National Bureau of Economic Research](https://www.nber.org/).
  - For simplicity, I will use "SSA state code" to refer to the first two
    digits of a 5-digit SSA code that identifies patient location.  Using this
    terminology, SSA state codes 1 to 53 correspond to the 50 US states,
    together with District of Columbia, Puerto Rico, and the US Virgin
    Islands.  For example, state code 53 corresponds to Wyoming.
  - SSA state codes above 53 are also defined:  for instance, 54 and 55 corresponds
    to Africa and Asia, respectively.
  - The SSA state codes in the dataset correspond to the 50 US states, together
    with the District of Columbia and Africa.

The number of healthcare providers in the dataset (including both training and
test data) is 6,763.  This is somewhat larger than the
[number of hospitals in the US in 2009](https://www.statista.com/statistics/185843/number-of-all-hospitals-in-the-us-since-2001/)
(5,795).

  - Is this apparent discrepancy due to the inclusion of Medicare patients
    living in Africa?  The number of providers in the dataset visited only by
    patients residing in Africa is 55.
  - The statistics on hospitals in the US originate from the American Hospital
    Association (AHA).  Although the description of the healthcare-fraud
    dataset on Kaggle refers to "hospital visits," it may be that not all
    healthcare providers visited met the AHA definition of a hospital.

The dataset includes information for <nobr>~ 690,000</nobr> visits to a
hospital (or similar healthcare provider), including <nobr>~ 50,000</nobr>
inpatient visits and <nobr>~ 640,000</nobr> outpatient visits.  By way of
comparison, the number of inpatient
[hospital visits in the US in 2009](https://www.hcup-us.ahrq.gov/reports/factsandfigures/2009/pdfs/FF_report_2009.pdf)
for which Medicare was the expected primary payer was 14.7 million.


## Data integrity {.unnumbered}

The dataset appears clean, and it passed several checks for consistency among
the data frames.

There is an apparent inconsistency in some outpatient visits:  the two
features that report payments for a visit (DeductibleAmtPaid,
InscClaimAmtReimbursed) are both equal to zero in some cases.

  - This is true for about 4% of the outpatient visits in the training data,
    for instance.
  - Does zero payment indicate that payment was refused because fraud was
    suspected?  Apparently not, because the fraction of zero-payment rows
    labeled as PotentialFraud (36.1%) is quite close to the fraction for the
    full training set of outpatient visits (36.6%).
  - A possible explanation is that the dataset includes claims to Medicare
    that were eventually covered by other insurers.
  - Another possibility is that in practice, hospitals receive zero payment
    for some outpatient visits, e.g., because the costs associated with
    collecting payment are too great to justify pursuing payment.

In most (or possibly all) cases, NA in the csv files can be viewed as an
artifact of the way in which the data is presented, rather than an indication
that a  valid data point is missing.

Columns with NA:

  1. The csv tables for inpatient and outpatient visits include a number of
     columns in which codes relevant for the visit can be reported.  For
     example, there are 10 columns ClmDiagnosisCode_1 through
     ClmDiagnosisCode_10 for claim diagnosis codes, and there are many NA in
     these columns.

      - Most NA in these columns can be viewed as an artifact of the table
        organization.
      - There are <nobr>~ 10,000</nobr> outpatient visits (but no inpatient
        visits) in the dataset that have NA for all code columns.
      - Is it plausible that 1.5% of outpatient Medicare claims have no codes,
        or is it more likely that the submitted codes are missing from the
        dataset?  Further research would be needed to answer this question.

   2. Similarly, three columns are reserved for physicians associated with the
      visit:  AttendingPhysician, OperatingPhysician, OtherPhysician.

      - Most NA in these columns can also be viewed as an artifact of the
        table organization.
      - There are 135 inpatient visits and 1688 outpatient visits with NA in
        all three of these columns.
      - Research questions:
        - Is an outpatient hospital visit necessarily associated with a
          physician?  For instance, a nurse practitioner may be able to fill
          in for a physician for certain outpatient visits.
        - Do certain combinations of codes tend to lack a physician?

  3. For about 2% of the inpatient visits (but not for any outpatient visits),
     DeductibleAmtPaid is NA.  As noted in the section on dataset scope, the
     deductible paid by inpatients was $1068 in all cases where it was not NA.

     - These NA probably correspond to visits for which the deductible payment
       was zero, the patient had already paid the full deductible for the year.
     - However there are samples that have NA for DeductibleAmtPaid with
       InscClaimAmtReimbursed equal to zero.  For instance, there are 25 rows
       of this sort in the training data.


# Analysis

## Chronic Conditions {.tabset}

### Summary {.unnumbered}

Since the dataset appears to represent a set of visits covered by Medicare,
it is expected that the patients are mainly elderly and that many have chronic
health problems.  However, the frequency of some chronic conditions among
these patients is quite high, and most patients have multiple chronic
conditions.

<div class="code-block" style="margin-top: 30px; margin-bottom: 30px;">

```{r, chronic-summary-1, echo=FALSE, cache=TRUE}
plot_number_of_conditions(patients, 'inpatient')
plot_chronic_count(patients, 'inpatient')
plot_chronic_percent(patients_concatenated, chronic_conditions[1])
```

</div>

Chronic conditions are widespread even among the Medicare patients who are not
elderly.  In the plot below, the patients under the age of 65 are disabled or
have a disease with special Medicare coverage (ALS or kidney failure).

<div class="summary-code-block">

```{r, chronic-summary-2, echo=FALSE, cache=TRUE}
plot_chronic_by_age(patients, chronic_conditions[1], 'inpatient')
```

</div>

The chronic conditions are widespread among the Medicare patients in all 50 US
states as well as in Africa.

<div class="summary-code-block">

```{r, chronic-summary-3, fig.height=10, echo=FALSE, cache=TRUE}
plot_chronic_by_location(patients, chronic_conditions[1], 'inpatient')
```

</div>

### Number of conditions per patient {.tab-display .unnumbered}

<div class="code-block">

```{r show-number-conditions, ref.label='number-conditions', eval=FALSE}
```

```{r, number-conditions, echo=FALSE, cache=TRUE}
for (claim_type in claim_types) {
    plot_number_of_conditions(patients, claim_type)
}
```

</div>


### Number of patients with condition {.tab-display .unnumbered}

<div class="code-block">

```{r show-number-patients, ref.label='number-patients', eval=FALSE}
```

```{r, number-patients, echo=FALSE, cache=TRUE}
plot_chronic_count(patients, 'inpatient')
plot_chronic_count(patients, 'outpatient')
```

</div>

### Percentage of patients with condition {.tab-display .unnumbered}

<div class="code-block">

```{r, chronic-percent, cache=TRUE}
for (variable_name in chronic_conditions) {
    plot_chronic_percent(patients_concatenated, variable_name)
}
```

</div>

### Patient age {.tab-display .unnumbered}

<div class="code-block">

```{r, show-chronic-age, ref.label='chronic-age', eval=FALSE}
```

```{r, chronic-age, echo=FALSE, cache=TRUE}
for (claim_type in claim_types) {
    plot_patient_age(patients, claim_type)
}

for (variable_name in chronic_conditions) {
    plot_chronic_by_age(patients, variable_name)
}
```

</div>

### Visits per patient {.tab-display .unnumbered}

<div class="code-block">

```{r, show-visits-per-patient, ref.label='visits-per-patient', eval=FALSE}
```

```{r, visits-per-patient, echo=FALSE, cache=TRUE}
for (claim_type in claim_types) {
    to_plot <- patients[[claim_type]]
    x_axis_values <- seq(min(to_plot$patient_claim_count),
                         max(to_plot$patient_claim_count))
    title <- str_c('Number of visits made by ', claim_type, 's')
    fig <- to_plot %>%
        ggplot(aes(x = patient_claim_count)) +
        geom_bar(fill = 'navyblue') +
        scale_x_discrete('Number of visits', limits = factor(x_axis_values)) +
        ylab('Number of patients') +
        ggtitle(title)
    print(fig)
}

for (variable_name in chronic_conditions) {
    plot_visits_per_patient(patients, variable_name)
}
```

</div>

### Geographic location {.tab-display .unnumbered}

<div class="code-block">

```{r, show-chronic-location, ref.label='chronic-location', eval=FALSE}
```

```{r, chronic-location, fig.height=10, echo=FALSE, cache=TRUE}
for (variable_name in chronic_conditions) {
    plot_chronic_by_location(patients, variable_name)
}
```

</div>

## Questions 1 {.tabset}

### Questions {.unnumbered}

How many medical doctors are there in the train outpatient dataset?

How many medical doctors are there in the train inpatient dataset? Do they
match with those from the outpatient record?

Do those inpatient patients show worse health conditions (in terms of chronic
diseases) than typical outpatient patients, or do those who have more visits
to the providers have worse health conditions? Provide an analysis on these
issues.

How many distinct patients (BeneIDs) are there in the in/out-patient datasets?

Do doctors serve for different providers? Study the distribution of hospital
counts/doctor? Is it possible to characterize those doctors who move around
among different providers?

Do patients go to different hospitals? Study the distribution of hospital
counts/patient? It is possible to characterize those patients who receive
services from a lot of different hospitals?

Do the same providers provide both inpatient and outpatient services?
Summarize your finding.

Do Some of the same patients receive both inpatient and outpatient services?
Summarize your finding.

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-1a, cache=TRUE}
# Number of inpatient and outpatient doctors, intersection between the two
# sets.
inpatient_doctors_vec <-  inpatient_doctors$doctor
outpatient_doctors_vec <- outpatient_doctors$doctor

# How many medical doctors are there in the train inpatient dataset?
length(inpatient_doctors_vec)
# How many medical doctors are there in the train outpatient dataset?
length(outpatient_doctors_vec)
# Do they match with those from the outpatient record?
length(intersect(inpatient_doctors_vec, outpatient_doctors_vec))
```

</div>


### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-1b, cache=TRUE}
# How many distinct patients (BeneIDs) are there in the in/out-patient
# datasets?
inpatients_vec <- inpatients$BeneID %>% unique()
length(inpatients_vec)
outpatients_vec <- outpatients$BeneID %>% unique()
length(outpatients_vec)
in_out_patients_vec <- intersect(inpatients_vec, outpatients_vec)
length(in_out_patients_vec)

for (claim_type in claim_types) {
    to_plot <- doctors[[claim_type]]
    x_axis_values <- seq(min(to_plot$provider_count),
                         max(to_plot$provider_count))
    title <- str_c('Number of providers per doctor for ', claim_type, 's')
    fig <- to_plot %>%
        ggplot(aes(x = provider_count)) +
        geom_bar(fill = 'navyblue') +
        scale_x_discrete('Number of providers',
                         limits = factor(x_axis_values)) +
        ylab('Number of doctors') +
        ggtitle(title)
    print(fig)
}

for (claim_type in claim_types) {
    to_plot <- patients[[claim_type]]
    x_axis_values <- seq(min(to_plot$provider_count),
                         max(to_plot$provider_count))
    title <- str_c('Number of providers per patient for ', claim_type, 's')
    fig <- to_plot %>%
        ggplot(aes(x = provider_count)) +
        geom_bar(fill = 'navyblue') +
        scale_x_discrete('Number of providers',
                         limits = factor(x_axis_values)) +
        ylab('Number of patients') +
        ggtitle(title)
    print(fig)
}

inpatient_providers_vec <- unique(inpatient_claims$Provider)
outpatient_providers_vec <- unique(outpatient_claims$Provider)
in_out_providers_vec <- intersect(inpatient_providers_vec,
                                  outpatient_providers_vec)
length(inpatient_providers_vec)
length(outpatient_providers_vec)
length(in_out_providers_vec)
```

</div>

## Questions 2 {.tabset}

### Questions {.unnumbered}

Study the relationship between the patient ages (at the time of their
service) and the counts of medical claims.

Study the relationship between the patient age and their chronic conditions.
Within the train-samples, do these chronic conditions show a definite trend
with respect to increasing ages?

In order to make sure the insurance premiums can cover the claims, the
insurance company would need to categorize the patients according to their
resource usage. In answering the question that what types of patients would
make more outpatient visits, please provide your finding.

In answering what types of patients would make more inpatient service claims,
please provide your findings.

From the prospect of the insurance company, the reimbursed amounts are their
coverage on the claims.  Please analyze the patterns of the total reimbursed
amounts (or average reimbursed amounts/visit) vs different types of patients.

From the prospect of the providers, the sum of reimbursed amounts and
deductibles are flowing to the providers. Based on this, analyze which types
of patients contribute more to the providers in terms of the aggregate charges
or the average charge per visit.


### Consumption of resources {.unnumbered}

The original question was about how many resources are consumed by different classes of patients.  That could still be interesting to include.

### Payments {.tab-display .unnumbered}

<div class="code-block">

```{r, payments, cache=TRUE}
plot_payments(patients)
```

</div>

## Questions 3 {.tabset}

### Questions {.unnumbered}

Based on the attribute **ClaimStartDt**, analyze the weekly service volume
variations.

What are the weekly patterns (weekly seasonalities) you observe for the
demands on **inpatient** or **outpatient** services?

Identify the top $5$ most frequent **ClmAdmitDiagnosisCodes** and trace their
weekly seasonalities.  Display the patterns you find.

For the inpatient patients, is there any pattern between the durations of the
treatments and the patient attributes?

For the monthly inpatient/outpatient claim counts of all the providers, please
analyze the table of provider-month matrices and report any interesting
findings.

**hint**: dataframe's pivot_table method could be used to construct the
provider-month matrix.

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-3a, cache=TRUE}
# From the plots of inpatient visits, it appears that the first and last weekly
# dates with complete data may be 2008-12-29, 2009-12-21, respectively.
#
# For the outpatient data, possibly 2009-01-05, 2009-12-21.
#
# Outside of these ranges, it's possible that the data is incomplete, so show
# weekly "seasonality" only in these ranges.
valid_date_ranges <- list(
    inpatient = as_date(c('2008-12-29', '2009-12-27'),
                        format = '%Y-%m-%d'),
    outpatient = as_date(c('2009-01-05', '2009-12-27'),
                         format = '%Y-%m-%d')
)

for (claim_type in claim_types) {
    to_plot <- claims[[claim_type]] %>%
        group_by(week_date) %>%
        summarise(count = n(), .groups = 'drop')

    title <- str_c('Weekly visit count, ', claim_type, 's')
    fig <- to_plot %>%
        ggplot(aes(x = week_date, y = count)) +
        geom_point(color = 'navyblue') +
        geom_line(color = 'navyblue') +
        xlab('Date') +
        ylab('Number of visits') +
        ggtitle(title)
    print(fig)
}

get_stl_model <- function(series_data) {
    stl_model <- stlplus(series_data$count, t = series_data$ClaimStartDt,
                         s.window = 'periodic', n.p = 7,
                         t.window = 29)
    return(stl_model)
}

for (claim_type in claim_types) {
    date_range <- valid_date_ranges[[claim_type]]
    to_plot <- claims[[claim_type]] %>%
        extract_series_data(date_range)

    title <- str_c('Daily visit count, ', claim_type, 's')
    fig <- plot_series(to_plot, title)
    print(fig)

    stl_model <- get_stl_model(to_plot)
    title <- str_c(
        'Decomposition of daily-visit time series, ', claim_type, 's'
    )
    print(plot(stl_model, main = title))

    title <- str_c('Weekly seasonality in visit count, ', claim_type, 's')
    fig <- plot_seasonality(to_plot, stl_model, title)
    print(fig)

    trend_curve <- trend(stl_model)
    trend_data <- data.frame(date = to_plot$ClaimStartDt, trend = trend_curve)
    title <- str_c('Trend in visit count, ', claim_type, 's')
    fig <- trend_data %>%
        ggplot(aes(x = date, y = trend)) +
        geom_line(color = 'navyblue') +
        xlab('Date') +
        ylab('Number of visits') +
        ggtitle(title)
    print(fig)
}
```

</div>

### Reason for visit {.tab-display .unnumbered}

<div class="code-block">

```{r, codes, cache=TRUE}
for (claim_type in claim_types) {
    to_plot <- freq_admit_codes[[claim_type]] %>%
        arrange(desc(count)) %>%
        mutate(description = reorder(description, count))

    title <- str_c('Top reasons for hospital visit, ', claim_type, 's')
    fig <- to_plot %>%
        ggplot(aes(x = description, y = count, fill = description)) +
        geom_col() +
        xlab('Reason for visit') +
        ylab('Number of visits') +
        coord_flip() +
        guides(fill = FALSE) +
        ggtitle(title)
    print(fig)
}

for (claim_type in claim_types) {
    date_range <- valid_date_ranges[[claim_type]]
    frequent_codes <- freq_admit_codes[[claim_type]] %>%
        arrange(desc(count))
    claim_data <- claims[[claim_type]] %>%
        filter(ClmAdmitDiagnosisCode %in% frequent_codes$code)

    for (admit_code in frequent_codes$code) {
        description <- code_descriptions[admit_code]
        series_data <- claim_data %>%
            filter(ClmAdmitDiagnosisCode == admit_code) %>%
            extract_series_data(date_range)

        title <- str_c('Daily visit count for ', tolower(description), ', ',
                       claim_type, 's')
        fig <- plot_series(series_data, title)
        print(fig)

        stl_model <- get_stl_model(series_data)

        title <- str_c('Weekly seasonality for ', tolower(description), ', ',
                       claim_type, 's')
        fig <- plot_seasonality(series_data, stl_model, title)
        print(fig)
    }
}
```

</div>

### Visit duration {.tab-display .unnumbered}

<div class="code-block">

```{r, visit-duration-1, cache=TRUE}
fig <- inpatient_claims %>%
    ggplot(aes(x = patient_age, y = visit_duration)) +
    geom_point(color = 'navyblue') +
    scale_x_continuous('Age') +
    scale_y_continuous('Visit duration') +
    ggtitle('Dependence of visit duration on patient age')
print(fig)

to_plot <- inpatient_claims %>%
    select(BeneID, visit_duration) %>%
    left_join(
        select(inpatients, BeneID, all_of(chronic_conditions)),
        by = 'BeneID'
    ) %>%
    mutate(across(all_of(chronic_conditions), ~ (.) == 'Y'))
to_plot$number_of_conditions <- factor(rowSums(to_plot[, chronic_conditions]))
fig <- to_plot %>%
    ggplot(aes(x = number_of_conditions, y = visit_duration)) +
    geom_boxplot(aes(fill = number_of_conditions)) +
    xlab('Number of chronic conditions') +
    scale_y_continuous('Visit duration') +
    guides(fill = FALSE) +
    ggtitle('Dependence of visit duration on number of chronic conditions')
print(fig)
```

</div>

### Provider claim counts {.tab-display .unnumbered}

<div class="code-block">

```{r, show-claim-counts, ref.label='claim-counts', eval=FALSE}
```

```{r, claim-counts, echo=FALSE, cache=TRUE}
plot_provider_claim_counts(provider_claim_counts, 'inpatient')
plot_provider_claim_counts(provider_claim_counts, 'outpatient')
```

</div>

## Questions 4 {.tabset}

### Questions {.unnumbered}

Study the distributions of **InscClaimAmtReimbursed**, **DeductibleAmtPaid**
for both inpatient and outpatient services. Your team might want to work with
hist, scatter or sns.pairplot, distplot, etc.

Study the distributions of insurance covered percentages
**InscClaimAmtReimbursed/(InscClaimAmtReimbursed+DeductibleAmtPaid)**.

Study the distributions of the durations of average insurance claims
(end-start) of the providers?  Box-plot/violin-plot based on the
**PotentialFraud** flag. Do you find any differences for none-potential fraud
vs potential-fraud providers?

How are the service durations related to the total claim amounts, i.e.
InscClaimAmtReimbursed+DeductibleAmtPaid?

Consider mean daily total charges (i.e. total charge/duration), please
describe their distribution.  How do the **Potential Fraud** flag affect the
distribution patterns?

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-4a, cache=TRUE}
for (claim_type in claim_types) {
    to_plot <- claims[[claim_type]] %>%
        select(visit_cost, InscClaimAmtReimbursed, DeductibleAmtPaid) %>%
        filter(visit_cost != 0) %>%
        mutate(percent_covered = InscClaimAmtReimbursed / visit_cost)

    title <- str_c('Insurer payments, ', claim_type, ' visits')
    fig <- plot_payment_distribution(to_plot, InscClaimAmtReimbursed, title)
    print(fig)

    title <- str_c('Deductible, ', claim_type, ' visits')
    fig <- plot_payment_distribution(to_plot, DeductibleAmtPaid, title)
    print(fig)

    title <- str_c('Insurer payment vs deductible, ', claim_type, ' visits')
    fig <- to_plot %>%
        ggplot(aes(x = DeductibleAmtPaid, y = InscClaimAmtReimbursed)) +
        geom_point(color = 'navyblue') +
        log_scale_dollar('Deductible', 'x') +
        log_scale_dollar('Payment by insurer', 'y') +
        ggtitle(title)
    print(fig)

    title <- str_c('Percent covered by insurer, ', claim_type, ' visits')
    fig <- to_plot %>%
        ggplot(aes(percent_covered)) +
        geom_histogram(fill = 'navyblue', bins = 30) +
        scale_x_continuous('Percent covered by insurer',
                           labels = percent_format()) +
        scale_y_continuous('Number of visits', labels = label_comma()) +
        ggtitle(title)
    print(fig)
}
```

</div>

### Claim durations {.tab-display .unnumbered}

<div class="code-block">

```{r, claim-duration, cache=TRUE}
for (claim_type in claim_types) {
    title <- str_c('Mean claim duration by provider, ', claim_type, ' visits')
    fig <- providers[[claim_type]] %>%
        ggplot(aes(x = PotentialFraud, y = mean_claim_duration)) +
        geom_boxplot(aes(fill = PotentialFraud)) +
        scale_y_continuous('Mean claim duration (days)') +
        xlab('Provider flagged for potential fraud') +
        guides(fill = FALSE) +
        ggtitle(title)
    print(fig)
}

for (claim_type in claim_types) {
    to_plot <- claims[[claim_type]] %>%
        filter(visit_cost != 0) %>%
        select(PotentialFraud, visit_cost, claim_duration, cost_per_claim_day)

    title <- str_c('Claim amount vs claim duration, ', claim_type, ' visits')
    fig_base <- to_plot %>%
        ggplot(aes(x = claim_duration, y = visit_cost)) +
        scale_x_continuous('Claim duration (days)')
    plot_cost_vs_duration(fig_base, title)

    plot_cost_per_day(to_plot, variable_name = 'cost_per_claim_day',
                      claim_type = claim_type, duration_label = 'claim')
}
```

</div>

### Visit duration {.tab-display .unnumbered}

<div class="code-block">

```{r, visit-duration-2, cache=TRUE}
to_plot <- inpatient_claims %>%
    filter(visit_cost != 0) %>%
    select(PotentialFraud, visit_cost, visit_duration, cost_per_visit_day,
           claim_duration)

    title <- str_c('Claim amount vs visit duration, inpatient visits')
    fig_base <- to_plot %>%
        ggplot(aes(x = visit_duration, y = visit_cost)) +
        scale_x_continuous('Visit duration (days)')
    plot_cost_vs_duration(fig_base, title)

    plot_cost_per_day(to_plot, variable_name = 'cost_per_visit_day',
                      claim_type = 'inpatient', duration_label = 'visit')

to_plot <- to_plot %>%
    mutate(duration_ratio = visit_duration / claim_duration)

fig <- to_plot %>%
    ggplot(aes(x = duration_ratio)) +
    geom_histogram(fill = 'navyblue') +
    ylab('Number of claims') +
    xlab('Ratio (visit duration / claim_duration)') +
    ggtitle('Ratio of visit_duration to claim duration')
print(fig)

to_plot <- to_plot %>%
    select(-visit_cost, -cost_per_visit_day) %>%
    pivot_longer(c(visit_duration, claim_duration),
                 names_to = 'duration_type',
                 values_to = 'duration')

fig <- to_plot %>%
    ggplot(aes(x = duration)) +
    ylab('Number of claims') +
    scale_x_discrete('Duration (days)') +
    geom_bar(
        aes(fill = duration_type), position = 'identity',
        alpha = 0.15
    ) +
    geom_freqpoly(
        aes(color = duration_type), position = 'identity',
        stat = 'count', size = 0.7
    ) +
    labs(fill = '', color = '') +
    ggtitle('Claim duration and visit duration for inpatients')
print(fig)

```

</div>

## Questions 5 {.tabset}

### Questions {.unnumbered}

An easier type of frauds is to submit duplicated claims using stolen patient
IDs.

While multiple claims with identical information are not always fraudulent,
the prevalence of these duplicated records would signal potential fraud
activities.

Consider the various diagnosis codes, procedure codes, admit diagnosis codes
as the key features, please identify the duplicated claims in the
inpatients_train, outpatients_train data.

Are these potentially fradulent providers duplicating their own medical
records, or are they using the records from the other providers?

Assuming that the claimStartDates are authentic, identify the providers which
are the information receivers. Identify the providers which are the
information givers.

Summarize the duplicate record counts/provider and study if the statistics
have different distributions between honest and potentialfraud providers.

Do these potentially fraud providers reuse doctor IDs and/or patient IDs?  If
so, these fradulent IDs (or if the doctors or patients willingly participate)
can be used as signals to the other types of fraudulent activities.

Do these duplicated records show any anomaly in terms of geographic locations?
Even though the original data doesn't specify the providers nor the doctors'
practice locations, one may use the majority of the patients' residence
state/county information to infer their physical locations.

Base on your best knowledge of suspicious activities in duplicating the
patient claims, flag the providers accordingly. Compare with the
**PotentialFraud** flags offered by the dataset and discuss.

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-5a, cache=TRUE}
to_plot <- filter_out_no_codes(inpatient_claims)
title_count_identical <- 'Number of duplicates submitted for '
fig_base <- to_plot %>%
    ggplot(aes(x = as.factor(identical_claim_count - 1))) +
        xlab('Number of duplicate claims submitted') +
        ggtitle(str_c(title_count_identical, 'inpatients'))
plot_bar_charts(fig_base, 'claims')

message <- str_c(
    'Consider only the claims for which there is at least one duplicate,\n',
    'and collect these into groups of identical claims.  The next plot\n',
    'answers the question:\n\n',
    'In these groups, how many providers are there per claim?\n'
)
cat(message)

to_plot <- to_plot %>%
    filter(identical_claim_count > 1)

title_per_provider <- 'Number of claims per provider in identical groups, '
fig_base <- to_plot %>%
    ggplot(aes(x = as.factor(identical_claims_per_provider))) +
    xlab('Number of claims per provider') +
    ggtitle(str_c(title_per_provider, 'inpatients'))
plot_bar_charts(fig_base, 'claims')

to_plot <- filter_out_no_codes(outpatient_claims)
fig_base <- to_plot %>%
    ggplot(aes(x = identical_claim_count - 1)) +
    scale_x_continuous('Number of duplicate claims submitted',
                       trans = pseudo_log_trans(base = 10),
                       breaks = c(0, 10, 100, 1e3, 1e4),
                       labels = label_comma(accuracy = 1)) +
    ggtitle(str_c(title_count_identical, 'outpatients'))
plot_histograms(fig_base, y_label = 'claims', bins = 20)

to_plot <- to_plot %>%
    filter(identical_claim_count > 1)

fig_base <- to_plot %>%
    ggplot(aes(x = identical_claims_per_provider)) +
    scale_x_continuous('Number of claims per provider',
                       breaks = seq(from = 1.0, to = 2.2, by = 0.2)) +
    ggtitle(str_c(title_per_provider, 'outpatients'))
plot_histograms(fig_base, y_label = 'claims', bins = 30,
                breaks = seq(from = 20e3, to = 100e3, by = 20e3))

# TODO (maybe):  Investigate the apparent outliers with ~2 claims per
#   provider.

```

```{r, questions-5b, cache=TRUE}
message <- str_c(
    'In a group of claims with identical codes, the earliest claim date is ',
    'found.\nAs a shorthand, the claim(s) on that date is referred to as ',
    '"original."\nIn the next two plots, the horizontal axis gives the ',
    'percent of a provider\'s\nclaims that are "original."'
)
cat(message)
plot_fraction_original(claims, 'inpatient')
plot_fraction_original(claims, 'outpatient')
```
</div>

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-5c, cache=TRUE}
```
