---
title: 'Healthcare Fraud Detection'
output:
  html_document:
    code_folding: show
    css: style.css
    highlight: tango
    number_sections: true
    theme: yeti
    toc: true
    toc_depth: 2
editor_options:
  chunk_output_type: console
---

```{r, setup, message=FALSE, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    fig.align = 'center',
    comment = ''
)

library(dplyr)
library(DT)
library(forcats)
library(ggplot2)
library(lubridate)
library(purrr)
library(reticulate)
library(scales)
library(stlplus)
library(stringr)
library(tidyr)

# Use the conda environment 'fraud' created for the project.
use_condaenv(condaenv = 'fraud')
```

## Questions 1 {.tabset}

### Questions {.unnumbered}

How many medical doctors are there in the train outpatient dataset?

How many medical doctors are there in the train inpatient dataset? Do they
match with those from the outpatient record?

Do those inpatient patients show worse health conditions (in terms of chronic
diseases) than typical outpatient patients, or do those who have more visits
to the providers have worse health conditions? Provide an analysis on these
issues.

How many distinct patients (BeneIDs) are there in the in/out-patient datasets?

Do doctors serve for different providers? Study the distribution of hospital
counts/doctor? Is it possible to characterize those doctors who move around
among different providers?

Do patients go to different hospitals? Study the distribution of hospital
counts/patient? It is possible to characterize those patients who receive
services from a lot of different hospitals?

Do the same providers provide both inpatient and outpatient services?
Summarize your finding.

Do Some of the same patients receive both inpatient and outpatient services?
Summarize your finding.

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, data-frames, cache=TRUE}
# This chunk loads csv data and uses dplyr operations to create data frames
# that are used for data analysis.

data_filenames <- list(
    train_outpatient = 'data/Train_Outpatientdata-1542865627584.csv',
    train_inpatient = 'data/Train_Inpatientdata-1542865627584.csv',
    train_provider = 'data/Train-1542865627584.csv',
    train_beneficiary = 'data/Train_Beneficiarydata-1542865627584.csv',
    test_outpatient = 'data/Test_Outpatientdata-1542969243754.csv',
    test_inpatient = 'data/Test_Inpatientdata-1542969243754.csv',
    test_provider = 'data/Test-1542969243754.csv',
    test_beneficiary = 'data/Test_Beneficiarydata-1542969243754.csv'
)

read_data <- function(file) {
    data <- read.csv(file, stringsAsFactors = FALSE,
                     na.strings = c('NA', ''))
    return(data)
}

data_frames <- map(data_filenames, read_data)

# Characterize missing values, ignoring columns such as ClmDiagnosisCode_n and
# ClmProcedureCode_n.
get_na_counts <- function(data) {
    na_counts <- data.frame(name = colnames(data),
                            count = as.integer(colSums(is.na(data))),
                            stringsAsFactors = FALSE) %>%
        filter(str_detect(name, 'Clm.+Code', negate = TRUE)) %>%
        arrange(desc(count)) %>%
        filter(count != 0)
    return(na_counts)
}

na_counts <- map(data_frames,
                 get_na_counts)

get_visit_counts <- function(visit_data) {
    visit_counts <- visit_data %>%
        group_by(BeneID) %>%
        summarise(visit_count = n(), .groups = 'drop')
    return(visit_counts)
}


# For time-series analysis, we want dates binned into weekly periods.  In
# order to facilite time-series analysis, generate a data frame of dates
# corresponding to the beginning of each weekly period.  Avoid errors
# associated with partial weeks at the end of a year by using lubridate's
# isoweek and isoyear functions.
get_claim_dates <- function(inpatient_data, outpatient_data) {

    all_claim_dates <- c(inpatient_data$ClaimStartDt,
                         outpatient_data$ClaimStartDt) %>%
        as_date(format = '%Y-%m-%d')
    start_date <- min(all_claim_dates)
    end_date <- max(all_claim_dates)
    daily_dates <- seq(start_date, end_date, by = 1)

    weekly_dates <- data.frame(date = daily_dates) %>%
        mutate(year = isoyear(date), week = isoweek(date)) %>%
        group_by(year, week) %>%
        summarise(week_date = min(date), .groups = 'drop')

    claim_dates <- list(
        daily = data.frame(ClaimStartDt = daily_dates),
        weekly = weekly_dates
    )

    return(claim_dates)
}

claim_dates <- get_claim_dates(
    data_frames$train_inpatient, data_frames$train_outpatient
)

augment_visit_data <- function(visit_data, patient_data, visit_type) {
    visit_counts <- get_visit_counts(visit_data)
    visit_data <- visit_data %>%
        mutate(type = visit_type) %>%
        mutate(across(c(ClaimStartDt, ClaimEndDt),
                      ~ as_date(., format = '%Y-%m-%d'))) %>%
        mutate(year = isoyear(ClaimStartDt),
               week = isoweek(ClaimStartDt)) %>%
        left_join(claim_dates$weekly, by = c('year', 'week')) %>%
        select(-c(year, week)) %>%
        left_join(visit_counts, by = 'BeneID')
    if (visit_type == 'inpatient') {
        visit_data <- visit_data %>%
            mutate(across(c(AdmissionDt, DischargeDt),
                          ~ as_date(., format = '%Y-%m-%d'))) %>%
            mutate(
                visit_duration = DischargeDt - AdmissionDt
            )
    }
    patient_data <- patient_data %>%
        select(BeneID, DOB, DOD) %>%
        mutate(across(c(DOB, DOD),
                      ~ as_date(., format = '%Y-%m-%d')))
    visit_data <- left_join(visit_data, patient_data, by = 'BeneID') %>%
        mutate(age = (ClaimStartDt - DOB) / 365.24)

    return(visit_data)
}

inpatient_visits <- augment_visit_data(data_frames$train_inpatient,
                                       data_frames$train_beneficiary,
                                       visit_type = 'inpatient')
outpatient_visits <- augment_visit_data(data_frames$train_outpatient,
                                        data_frames$train_beneficiary,
                                        visit_type = 'outpatient')
inpatient_only_columns <- c('AdmissionDt', 'DischargeDt',
                            'DiagnosisGroupCode', 'visit_duration')
patient_visits <- rbind(
    select(inpatient_visits, -all_of(inpatient_only_columns)),
    outpatient_visits,
    make.row.names = FALSE
)

chronic_conditions_raw <- c(
    'ChronicCond_Alzheimer', 'ChronicCond_Heartfailure',
    'ChronicCond_KidneyDisease', 'ChronicCond_Cancer',
    'ChronicCond_ObstrPulmonary', 'ChronicCond_Depression',
    'ChronicCond_Diabetes', 'ChronicCond_IschemicHeart',
    'ChronicCond_Osteoporasis', 'ChronicCond_rheumatoidarthritis',
    'ChronicCond_stroke'
)
clean_condition_names <- function(column_names) {
    new_names <- str_replace(column_names, '^ChronicCond_', '')
    new_names <- case_when(
        str_detect(new_names, 'Heartfailure') ~ 'HeartFailure',
        str_detect(new_names, 'Osteoporasis') ~ 'Osteoporosis',
        str_detect(new_names, 'rheumatoidarthritis') ~ 'RheumatoidArthritis',
        str_detect(new_names, 'stroke') ~ 'Stroke',
        TRUE ~ new_names
    )
    return(new_names)
}
chronic_conditions <- clean_condition_names(chronic_conditions_raw)

patient_ages <- patient_visits %>%
    select(BeneID, age) %>%
    group_by(BeneID) %>%
    summarise(age = median(age), .groups = 'drop')

augment_patient_data <- function(patient_data, visit_data, visit_type) {
    patient_data <- patient_data %>%
        filter(BeneID %in% visit_data$BeneID) %>%
        mutate(type = visit_type) %>%
        rename_with(.fn = clean_condition_names,
                    .cols = all_of(chronic_conditions_raw)) %>%
        mutate(across(all_of(chronic_conditions),
                      ~ fct_recode(factor(.), 'Y' = '1', 'N' = '2')))
    visit_counts <- get_visit_counts(visit_data)
    provider_counts <- visit_data %>%
        select(Provider, BeneID) %>%
        distinct() %>%
        group_by(BeneID) %>%
        summarise(provider_count = n(), .groups = 'drop')
    # For both the training and test sets, the inpatient data frame has
    # missing values for DeductibleAmtPaid, but the minimum value for the
    # column is about $1000.  So in this context, it seems that NA is used in
    # place of zero.
    #
    # For the outpatient data frames, however, there are many zero values in
    # DeductibleAmtPaid but no missing values.
    #
    # However, it appears that there are missing values in
    # InscClaimAmtReimbursed and DeductibleAmtPaid for both the inpatient and
    # outpatient data.  For a number of rows, InscClaimAmtReimbursed and
    # DeductibleAmtPaid are both zero, which gives a cost of zero for the
    # visit to the hospital.  For the training set of outpatient visits, for
    # instance, there are about 19k rows like this (out of about 520k). Data
    # analysis involving vist cost needs to take account of this.
    payments <- visit_data %>%
        select(BeneID, InscClaimAmtReimbursed, DeductibleAmtPaid) %>%
        replace_na(list(DeductibleAmtPaid = 0)) %>%
        mutate(visit_cost = InscClaimAmtReimbursed + DeductibleAmtPaid) %>%
        filter(visit_cost != 0) %>%
        select(-DeductibleAmtPaid) %>%
        group_by(BeneID) %>%
        summarise(
            total_reimbursed = sum(InscClaimAmtReimbursed),
            reimbursed_per_visit = mean(InscClaimAmtReimbursed),
            total_charged = sum(visit_cost),
            charged_per_visit = mean(visit_cost),
            .groups = 'drop'
        )
    patient_data <- patient_data %>%
        left_join(payments, by = 'BeneID') %>%
        left_join(patient_ages, by = 'BeneID') %>%
        left_join(provider_counts, by = 'BeneID') %>%
        left_join(visit_counts, by = 'BeneID') %>%
        mutate(type = visit_type)

    return(patient_data)
}
inpatients <- augment_patient_data(
    data_frames$train_beneficiary,
    data_frames$train_inpatient,
    'inpatient'
)
outpatients <- augment_patient_data(
    data_frames$train_beneficiary,
    data_frames$train_outpatient,
    'outpatient'
)
patients <- rbind(inpatients, outpatients,
                  make.row.names = FALSE)

doctor_colnames <- c('AttendingPhysician', 'OperatingPhysician',
                     'OtherPhysician')

get_doctor_data <- function(visit_data, visit_type) {
    doctor_data <- visit_data %>%
        select(Provider, all_of(doctor_colnames)) %>%
        pivot_longer(all_of(doctor_colnames), names_to = 'role',
                     values_to = 'doctor') %>%
        select(-role) %>%
        drop_na(doctor) %>%
        distinct() %>%
        group_by(doctor) %>%
        summarise(provider_count = n(), .groups = 'drop') %>%
        mutate(type = visit_type)
    return(doctor_data)
}

in_doctors <- get_doctor_data(
    data_frames$train_inpatient,
    'inpatient'
)
out_doctors <- get_doctor_data(
    data_frames$train_outpatient,
    'outpatient'
)
doctors <- rbind(in_doctors, out_doctors,
                 make.row.names = FALSE)

get_provider_data <- function(visit_data, visit_type) {
    provider_data <- visit_data %>%
        mutate(
            ClaimStartDt = as_date(ClaimStartDt, format = '%Y-%m-%d')
        ) %>%
        mutate(claim_year = year(ClaimStartDt),
               claim_month = month(ClaimStartDt, label = TRUE, abbr = TRUE)) %>%
        group_by(Provider, claim_year, claim_month) %>%
        summarise(claim_count = n(), .groups = 'drop') %>%
        mutate(type = visit_type)
    return(provider_data)
}

in_providers <- get_provider_data(
    data_frames$train_inpatient,
    'inpatient'
)
out_providers <- get_provider_data(
    data_frames$train_outpatient,
    'outpatient'
)
providers <- rbind(in_providers, out_providers,
                   make.row.names = FALSE)

code_descriptions <- c(
    'Chest pain', 'Shortness of breath', 'Pneumonia',
    'Congestive heart failure', 'Syncope (fainting)', 'Mammogram',
    'Irregular heartbeat', 'High blood pressure', 'Diabetes',
    'Prescription monitoring'
)
names(code_descriptions) <- c(
    '78650', '78605', '486', '4280', '7802',
    'V7612', '42731', '4019', '25000', 'V5883'
)
find_frequent_codes <- function(visit_data, visit_type) {
    frequent_codes <- visit_data %>%
        mutate(code = ClmAdmitDiagnosisCode) %>%
        group_by(code) %>%
        summarise(count = n(), .groups = 'drop') %>%
        drop_na() %>%
        arrange(desc(count)) %>%
        head(n = 5) %>%
        mutate(description = code_descriptions[code], type = visit_type)
    return(frequent_codes)
}
freq_admit_codes_inpatient <- find_frequent_codes(
    data_frames$train_inpatient,
    'inpatient'
)
freq_admit_codes_outpatient <- find_frequent_codes(
    data_frames$train_outpatient,
    'outpatient'
)
freq_admit_codes <- rbind(
    freq_admit_codes_inpatient,
    freq_admit_codes_outpatient,
    make.row.names = FALSE
)
```

```{r, questions-1a, cache=TRUE}
# Number of inpatient and outpatient doctors, intersection between the two
# sets.
in_doctors_vec <-  in_doctors$doctor
out_doctors_vec <- out_doctors$doctor

# How many medical doctors are there in the train inpatient dataset?
length(in_doctors_vec)
# How many medical doctors are there in the train outpatient dataset?
length(out_doctors_vec)
# Do they match with those from the outpatient record?
length(intersect(in_doctors_vec, out_doctors_vec))
```

</div>

### Chronic conditions {.tab-display .unnumbered}

<div class="code-block">

```{r, show-chronic, ref.label='chronic-1', eval=FALSE}
```

```{r, chronic-1, cache=TRUE, echo=FALSE}
chronic_condition_labels <- case_when(
    str_detect(chronic_conditions, 'Alzheimer') ~ 'Alzheimer\'s disease',
    str_detect(chronic_conditions, 'HeartFailure') ~ 'heart failure',
    str_detect(chronic_conditions, 'KidneyDisease') ~ 'kidney disease',
    str_detect(chronic_conditions, 'IschemicHeart') ~ 'ischemic heart',
    str_detect(chronic_conditions,
               'ObstrPulmonary') ~ 'obstructive\npulmonary\ndisease',
    str_detect(chronic_conditions,
               'RheumatoidArthritis') ~ 'rheumatoid arthritis',
    TRUE ~ tolower(chronic_conditions)
)
names(chronic_condition_labels) <- chronic_conditions

first_char_to_upper <- function(label) {
   first_char <- str_sub(label, 1, 1)
    str_sub(label, 1, 1) <- str_to_upper(first_char)
    return(label)
}

# The input to this function is a vector of strings that specify a chronic
# condition.  The strings in the vector are column names such as
# 'IschemicHeart'.  The vector returned by the function has strings that work
# better in labelling the y axis of a plot, e.g., 'IschemicHeart' has been
# replaced by 'Ischemic heart'.
convert_to_labels <- function(condition_vec) {
    labels <- chronic_condition_labels[condition_vec] %>%
        first_char_to_upper() %>%
        # Replace only the first newline (in cases where 2 newlines are used
        # in legend titles), so that very long labels still include a newline.
        str_replace('\n', ' ')
    return(labels)
}

visit_types <- c('inpatient', 'outpatient')

for (visit_type in visit_types) {
    to_plot <- patients %>%
        filter(type == visit_type)
    x_axis_values <- seq(min(to_plot$visit_count),
                         max(to_plot$visit_count))
    title <- str_c('Number of visits made by ', visit_type, 's')
    fig <- ggplot(to_plot, aes(x = visit_count)) +
        geom_bar(fill = 'navyblue') +
        scale_x_discrete('Number of visits', limits = factor(x_axis_values)) +
        ylab('Number of patients') +
        ggtitle(title)
    print(fig)
}

for (column_name in chronic_conditions) {
    condition_label <- chronic_condition_labels[column_name]
    legend_title <- first_char_to_upper(condition_label)
    condition_label <- str_replace_all(condition_label, '\n', ' ')
    title_base <- str_c('Distribution of ', condition_label)

    fig <- ggplot(patients, aes_string(x = 'type', fill = column_name)) +
        geom_bar(position = 'fill') +
        scale_y_continuous('Fraction of patients') +
        scale_x_discrete(name = '') +
        scale_fill_discrete(legend_title) +
        ggtitle(title_base)
    print(fig)

    for (visit_type in visit_types) {
        to_plot <- patients %>%
            filter(type == visit_type)
        x_axis_values <- seq(min(to_plot$visit_count),
                             max(to_plot$visit_count))
        title <- str_c(title_base, ', ', visit_type, 's')
        fig <- to_plot %>%
            ggplot(aes_string(x = 'visit_count', fill = column_name)) +
            geom_bar(position = 'fill') +
            scale_x_discrete('Number of visits',
                             limits = factor(x_axis_values)) +
            scale_fill_discrete(legend_title) +
            ylab('Number of patients') +
            ggtitle(title)
        print(fig)
    }
}
```

</div>

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-1b, cache=TRUE}
# How many distinct patients (BeneIDs) are there in the in/out-patient datasets?
inpatients_vec <- inpatients$BeneID %>% unique()
length(inpatients_vec)
outpatients_vec <- outpatients$BeneID %>% unique()
length(outpatients_vec)
in_out_patients_vec <- intersect(inpatients_vec, outpatients_vec)
length(in_out_patients_vec)

for (visit_type in visit_types) {
    to_plot <- doctors %>%
        filter(type == visit_type)
    x_axis_values <- seq(min(to_plot$provider_count),
                         max(to_plot$provider_count))
    title <- str_c('Number of providers per doctor for ', visit_type, 's')
    fig <- ggplot(to_plot, aes(x = provider_count)) +
        geom_bar(fill = 'navyblue') +
        scale_x_discrete('Number of providers',
                         limits = factor(x_axis_values)) +
        ylab('Number of doctors') +
        ggtitle(title)
    print(fig)
}

for (visit_type in visit_types) {
    to_plot <- patients %>%
        filter(type == visit_type)
    x_axis_values <- seq(min(to_plot$provider_count),
                         max(to_plot$provider_count))
    title <- str_c('Number of providers per patient for ', visit_type, 's')
    fig <- ggplot(to_plot, aes(x = provider_count)) +
        geom_bar(fill = 'navyblue') +
        scale_x_discrete('Number of providers',
                         limits = factor(x_axis_values)) +
        ylab('Number of patients') +
        ggtitle(title)
    print(fig)
}

in_providers_vec <- unique(inpatient_visits$Provider)
out_providers_vec <- unique(outpatient_visits$Provider)
in_out_providers_vec <- intersect(in_providers_vec, out_providers_vec)
length(in_providers_vec)
length(out_providers_vec)
length(in_out_providers_vec)
```

</div>

## Questions 2 {.tabset}

### Questions {.unnumbered}

Study the relationship between the patient ages (at the time of their
service) and the counts of medical claims.

Study the relationship between the patient age and their chronic conditions.
Within the train-samples, do these chronic conditions show a definite trend
with respect to increasing ages?

In order to make sure the insurance premiums can cover the claims, the
insurance company would need to categorize the patients according to their
resource usage. In answering the question that what types of patients would
make more outpatient visits, please provide your finding.

In answering what types of patients would make more inpatient service claims,
please provide your findings.

From the prospect of the insurance company, the reimbursed amounts are their
coverage on the claims.  Please analyze the patterns of the total reimbursed
amounts (or average reimbursed amounts/visit) vs different types of patients.

From the prospect of the providers, the sum of reimbursed amounts and
deductibles are flowing to the providers. Based on this, analyze which types
of patients contribute more to the providers in terms of the aggregate charges
or the average charge per visit.

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-2a, cache=TRUE}
for (visit_type in visit_types) {
    to_plot <- patient_visits %>%
        filter(type == visit_type) %>%
        mutate(age = as.integer(round(age)))
    title <- str_c('Number of visits by patient age, ', visit_type, 's')
    fig <- ggplot(to_plot, aes(x = age)) +
        geom_histogram(fill = 'navyblue', bins = 20) +
        ylab('Number of visits') +
        xlab('Patient age') +
        ggtitle(title)
    print(fig)
}
```

</div>

### Chronic conditions {.tab-display .unnumbered}

<div class="code-block">

```{r, chronic-2, cache=TRUE}
for (column_name in chronic_conditions) {
    condition_label <- chronic_condition_labels[column_name]
    legend_title <- first_char_to_upper(condition_label)
    condition_label <- str_replace_all(condition_label, '\n', ' ')
    for (visit_type in visit_types) {
        to_plot <- patients %>%
            filter(type == visit_type) %>%
            mutate(age = as.integer(round(age)))

        title <- str_c('Distribution of ', condition_label,
                       ' by age, ', visit_type, 's'
        )
        fig <- to_plot %>%
            ggplot(aes(x = age)) +
            geom_histogram(
                aes_string(fill = column_name), position = 'identity',
                bins = 20, alpha = 0.15
            ) +
            geom_freqpoly(
                aes_string(color = column_name), position = 'identity',
                bins = 20, size = 0.7
            ) +
            ylab('Number of patients') +
            xlab('Patient age') +
            labs(fill = legend_title, color = legend_title) +
            ggtitle(title)
        print(fig)
    }
}
```

</div>

### Number of visits {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-2b, cache=TRUE}
for (visit_type in visit_types) {
    to_plot <- patients %>%
        filter(type == visit_type) %>%
        select(all_of(chronic_conditions))
    to_plot_vec <- colSums(to_plot == 'Y')
    vec_labels <- convert_to_labels(names(to_plot_vec)) %>%
        factor() %>%
        reorder(to_plot_vec)
    to_plot <- data.frame(label = vec_labels, visit_count = to_plot_vec)
    title <- str_c('Number of visits, ', visit_type, 's')
    fig <- ggplot(to_plot, aes(x = label, y = visit_count)) +
        geom_col(aes(fill = label)) +
        xlab('Chronic condition') +
        ylab('Number of visits') +
        coord_flip() +
        guides(fill = FALSE) +
        ggtitle(title)
    print(fig)
}
```

</div>

### Payments {.tab-display .unnumbered}

<div class="code-block">

```{r, payments, cache=TRUE}
payment_colnames <- c('total_reimbursed', 'reimbursed_per_visit',
                      'total_charged', 'charged_per_visit')
payment_labels <- c(
    'Total payment by insurance per patient',
    'Mean payment by insurance per patient per visit',
    'Total paid to hospitals per patient',
    'Mean paid to hospital per patient per visit'
)
names(payment_labels) <- payment_colnames

generate_condition_column <- function(data) {
    data <- pivot_longer(data, all_of(chronic_conditions),
                         names_to = 'condition', values_to = 'value') %>%
        filter(value == 'Y') %>%
        select(-value) %>%
        # Modify the conditions names to improve plot readability.
        mutate(condition = convert_to_labels(condition))
    return(data)
}

for (visit_type in visit_types) {
    to_select <- c(payment_colnames, chronic_conditions)
    to_plot <- patients %>%
        filter(type == visit_type) %>%
        select(all_of(to_select)) %>%
        # Patients for which the only visit has visit_cost == 0 show up with
        # missing values for the columns in payment_colnames.
        drop_na() %>%
        # A logarithmic scale will be used so 0 is replaced by 1.
        mutate(across(all_of(payment_colnames),
                      ~ replace(., (.) == 0, 1))) %>%
        generate_condition_column()
    for (column_name in payment_colnames) {
        title <- str_c(payment_labels[column_name], ', ', visit_type, 's')
        fig <- ggplot(to_plot, aes_string(x = 'condition', y = column_name)) +
            geom_boxplot(aes(fill = condition)) +
            scale_y_continuous('Payment amount', trans = 'log10',
                               labels = label_dollar()) +
            xlab('Chronic condition') +
            coord_flip() +
            guides(fill = FALSE) +
            ggtitle(title)
        print(fig)
    }
}
```

</div>

## Questions 3 {.tabset}

### Questions {.unnumbered}

Based on the attribute **ClaimStartDt**, analyze the weekly service volume
variations.

What are the weekly patterns (weekly seasonalities) you observe for the
demands on **inpatient** or **outpatient** services?

Identify the top $5$ most frequent **ClmAdmitDiagnosisCodes** and trace their
weekly seasonalities.  Display the patterns you find.

For the inpatient patients, is there any pattern between the durations of the
treatments and the patient attributes?

For the monthly inpatient/outpatient claim counts of all the providers, please
analyze the table of provider-month matrices and report any interesting
findings.

**hint**: dataframe's pivot_table method could be used to construct the
provider-month matrix.

### Answers {.tab-display .unnumbered}

<div class="code-block">

```{r, questions-3a, cache=TRUE}
# From the plots of inpatient visits, it appears that the first and last weekly
# dates with complete data may be 2008-12-29, 2009-12-21, respectively.
#
# For the outpatient data, possibly 2009-01-05, 2009-12-21.
#
# Outside of these ranges, it's possible that the data is incomplete, so show
# weekly "seasonality" only in these ranges.
valid_date_ranges <- list(
    inpatient = as_date(c('2008-12-29', '2009-12-27'),
                        format = '%Y-%m-%d'),
    outpatient = as_date(c('2009-01-05', '2009-12-27'),
                         format = '%Y-%m-%d')
)

for (visit_type in visit_types) {
    to_plot <- patient_visits %>%
        filter(type == visit_type) %>%
        group_by(week_date) %>%
        summarise(count = n(), .groups = 'drop')

    title <- str_c('Weekly visit count, ', visit_type, 's')
    fig <- ggplot(to_plot, aes(x = week_date, y = count)) +
        geom_point(color = 'navyblue') +
        geom_line(color = 'navyblue') +
        xlab('Date') +
        ylab('Number of visits') +
        ggtitle(title)
    print(fig)
}

extract_series_data <- function(visit_data, date_range) {
    series_data <-  visit_data %>%
        group_by(ClaimStartDt) %>%
        summarise(count = n(), .groups = 'drop') %>%
        # The full join guarantees that there are no missing days in the
        # time-series data.  This is needed for seasonal analysis.
        full_join(claim_dates$daily, by = 'ClaimStartDt') %>%
        replace_na(replace = list(count = 0)) %>%
        filter(ClaimStartDt >= date_range[1],
               ClaimStartDt <= date_range[2]) %>%
        arrange(ClaimStartDt)
    return(series_data)
}

plot_series <- function(to_plot, title) {
    fig <- ggplot(to_plot, aes(x = ClaimStartDt, y = count)) +
        geom_point(color = 'navyblue') +
        geom_line(color = 'navyblue') +
        xlab('Date') +
        ylab('Number of visits') +
        ggtitle(title)
    return(fig)
}

get_stl_model <- function(series_data) {
    stl_model <- stlplus(series_data$count, t = series_data$ClaimStartDt,
                         s.window = 'periodic', n.p = 7,
                         t.window = 29)
    return(stl_model)
}

plot_seasonality <- function(series_data, stl_model, title) {
    seasonality <- seasonal(stl_model)[1:7]
    weekday <- wday(series_data$ClaimStartDt[1:7], label = TRUE)
    seasonality_data <- data.frame(weekday = weekday,
                                   seasonality = seasonality)

    fig <- ggplot(seasonality_data,
                  aes(x = weekday, y = seasonality, group = 1)) +
        geom_line(color = 'navyblue') +
        geom_point(color = 'navyblue') +
        xlab('Weekday') +
        ylab('Number of visits') +
        ggtitle(title)

    return(fig)
}

for (visit_type in visit_types) {
    date_range <- valid_date_ranges[[visit_type]]
    to_plot <- patient_visits %>%
        filter(type == visit_type) %>%
        extract_series_data(date_range)

    title <- str_c('Daily visit count, ', visit_type, 's')
    fig <- plot_series(to_plot, title)
    print(fig)

    stl_model <- get_stl_model(to_plot)
    title <- str_c(
        'Decomposition of daily-visit time series, ', visit_type, 's'
    )
    print(plot(stl_model, main = title))

    title <- str_c('Weekly seasonality in visit count, ', visit_type, 's')
    fig <- plot_seasonality(to_plot, stl_model, title)
    print(fig)

    trend_curve <- trend(stl_model)
    trend_data <- data.frame(date = to_plot$ClaimStartDt, trend = trend_curve)
    title <- str_c('Trend in visit count, ', visit_type, 's')
    fig <- ggplot(trend_data,
                  aes(x = date, y = trend)) +
        geom_line(color = 'navyblue') +
        xlab('Date') +
        ylab('Number of visits') +
        ggtitle(title)
    print(fig)
}
```

</div>

### Reason for visit {.tab-display .unnumbered}

<div class="code-block">

```{r, codes, cache=TRUE}
for (visit_type in visit_types) {
    to_plot <- freq_admit_codes %>%
        filter(type == visit_type) %>%
        arrange(desc(count)) %>%
        mutate(description = reorder(description, count))

    title <- str_c('Top reasons for hospital visit, ', visit_type, 's')
    fig <- ggplot(to_plot,
                  aes(x = description, y = count, fill = description)) +
        geom_col() +
        xlab('Reason for visit') +
        ylab('Number of visits') +
        coord_flip() +
        guides(fill = FALSE) +
        ggtitle(title)
    print(fig)
}

for (visit_type in visit_types) {
    date_range <- valid_date_ranges[[visit_type]]
    frequent_codes <- freq_admit_codes %>%
        filter(type == visit_type) %>%
        arrange(desc(count))
    visit_data <- patient_visits %>%
        filter(type == visit_type,
               ClmAdmitDiagnosisCode %in% frequent_codes$code)

    for (admit_code in frequent_codes$code) {
        description <- code_descriptions[admit_code]
        series_data <- visit_data %>%
            filter(ClmAdmitDiagnosisCode == admit_code) %>%
            extract_series_data(date_range)

        title <- str_c('Daily visit count for ', tolower(description), ', ',
                       visit_type, 's')
        fig <- plot_series(series_data, title)
        print(fig)

        stl_model <- get_stl_model(series_data)

        title <- str_c('Weekly seasonality for ', tolower(description), ', ',
                       visit_type, 's')
        fig <- plot_seasonality(series_data, stl_model, title)
        print(fig)
    }
}
```

</div>

### Visit duration {.tab-display .unnumbered}

<div class="code-block">

```{r, duration, cache=TRUE}
fig <- ggplot(inpatient_visits, aes(x = age, y = visit_duration)) +
    geom_point(color = 'navyblue') +
    scale_x_continuous('Age') +
    scale_y_continuous('Visit duration') +
    ggtitle('Dependence of visit duration on patient age')
print(fig)

to_plot <- inpatient_visits %>%
    select(BeneID, visit_duration) %>%
    left_join(
        select(inpatients, BeneID, all_of(chronic_conditions)),
        by = 'BeneID'
    ) %>%
    mutate(across(all_of(chronic_conditions), ~ (.) == 'Y'))
to_plot$number_of_conditions <- factor(rowSums(to_plot[, chronic_conditions]))
fig <- ggplot(to_plot, aes(x = number_of_conditions, y = visit_duration)) +
    geom_boxplot(aes(fill = number_of_conditions)) +
    xlab('Number of chronic conditions') +
    scale_y_continuous('Visit duration') +
    guides(fill = FALSE) +
    ggtitle('Dependence of visit duration on number of chronic conditions')
print(fig)
```

</div>

### Provider claim counts {.tab-display .unnumbered}

<div class="code-block">

```{r, show-claim-counts, ref.label='claim-counts', eval=FALSE}
```

```{r, claim-counts, cache=TRUE, echo=FALSE}
plot_claim_counts <- function(visit_type) {
    plot_data <- providers %>%
        filter(type == visit_type, claim_year == 2009)

    to_plot <- plot_data %>%
        group_by(Provider) %>%
        summarise(count = sum(claim_count), .groups = 'drop')
    title <- str_c('Number of claims per provider in 2009, ', visit_type, 's')
    fig <- ggplot(to_plot, aes(x = count)) +
        geom_histogram(fill = 'navyblue', bins = 50) +
        xlab('Number of claims') +
        ylab('Number of providers') +
        ggtitle(title)
    print(fig)

    cat('The maximum number of ', visit_type, ' claims for a provider is ',
        max(to_plot$count), '.\n', sep = '')

    to_plot <- plot_data %>%
        group_by(claim_month) %>%
        summarise(count = sum(claim_count), .groups = 'drop')
    title <- str_c('Number of claims per month in 2009, ', visit_type, 's')
    fig <- ggplot(to_plot,
                  aes(x = claim_month, y = count)) +
        geom_col(fill = 'navyblue') +
        xlab('Month') +
        ylab('Number of claims') +
        ggtitle(title)
    print(fig)

    to_display <- plot_data %>%
        group_by(claim_month) %>%
        summarise(max_claims = max(claim_count), .groups = 'drop')
    table_alignment <- list(className = 'dt-center', targets = '_all')
    return(datatable(
        to_display,
        rownames = FALSE,
        colnames = c('Month', str_c('Max ', visit_type, ' claims per provider')),
        options = list(
            dom = 't',
            columnDefs = list(table_alignment),
            pageLength = 12
        )
    ))
}
plot_claim_counts('inpatient')
plot_claim_counts('outpatient')
```

</div>
